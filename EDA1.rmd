---
output:
  html_document: default
  pdf_document: default
---
e---
title: "Unit 8-9 | EDA1"
author: "Lani Lewis"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
This area is used to setup R studio for this project
```{r}
# LIBRARIES ####
library(maps) # lat and long
library(usmap)
library(caret) # confusion Matrix
library(e1071) # navebayes
library(class) # knn
#library(tm) #text mining library provides the stopwords() function
library(tidyr)
#library(plyr)
#library(jsonlite)
library(dplyr)
library(tidyverse)
library(stringr) # string manipulation
#library(mvtnorm)
library(ggplot2)
library(ggthemes) # Plot Themes
library(plotly)
```


Import in all datasets
```{r}
# IMPORT DATASETS ####
# Import Beers data set
beers <- read.csv(choose.files(),header = T)
```
```{r}
# Import Breweries data set
breweries <- read.csv(choose.files(),header = T)
```
```{r}
# Import Breweries data set
state_abb_list <- read.csv(choose.files(),header = T)

# Change column names
colnames(state_abb_list)[1] <- c("Full_State")
colnames(state_abb_list)[3] <- c("State")

```

```{r}
# UNDERSTAND DATASETS ####
# What kind of data am I looking at
str(beers)

str(breweries)

str(state_abb_list)
```

```{r}
# REVIEW MISSING VALUES ####
# beers dataset has missing values in IBU & ABV column
view(beers)

## SFAE BEER DATASET CHECKPOINT ####
safe_beers = beers

# There is missing values in some of the rows not all. 
```


Handling Missing Data Files for Question #3
```{r}
## Look at only NA Values in beers data set ####
beers_na = beers

# create a logical vector indicating which rows have missing values
na_rows <- apply(is.na(beers_na), 1, any)

beers_na <- beers_na[na_rows, ]

str(beers_na)
```

```{r}
#### Check and make sure I only see na in ABV(3) and IBU(4) columns ####
which(is.na(beers_na), arr.ind = TRUE)
```

```{r}
#### Count how many objects are NA in the ABV column ####
ABV_na_Index <- which(is.na(beers_na$ABV), arr.ind = TRUE)
# 62 rows

ABV_CNT <- length(ABV_na_Index)

ABV_CNT
```

```{r}
#### Count how many objects are NA in the IBU column ####
IBU_na_Index <- which(is.na(beers_na$IBU), arr.ind = TRUE)
# 1005 rows

IBU_Cnt <- length(IBU_na_Index)

IBU_Cnt
```

```{r}
#### Understand which rows are missing both ABV and IBU ####
#str(which(is.na(beers_na$IBU) & is.na(beers_na$ABV), arr.ind = TRUE))

#which(is.na(beers_na$IBU) & is.na(beers_na$ABV), arr.ind = TRUE)

# 62 matches so for every ABV NA there will also be an NA IBU
# Check this theory
beers_na[112, ] # Double Play Pilsner | 1541
beers_na[117, ] # N Street Drive-In 50th Anniversary IPA |  1025
beers_na[123, ] # Professor Black | 2490
beers_na[124, ] # Little Boss | 2489
beers_na[125, ] # Van Dayum! | 2488
```


```{r}
# MIssing Data PLot 1 ####
g <- ggplot() +
  geom_bar(aes(y = length(IBU_na_Index), x = length(ABV_na_Index)), stat = "Identity")


ggplotly(g)
```

```{r}
# MIssing Data PLot 2 ####
beers_na %>%
  ggplot() +
  geom_point(aes(y = as.factor(Style), x = as.factor(Ounces), color = as.factor(Ounces)), position = "jitter") + 
  xlab("Ounces of Beer") +
  ylab("Style of Beer") +
  labs(color = "Ounces") 
```


```{r}
# EXPORT NA FIELDS TO CSV ####
write.csv(beers_na, "Missing_Data.csv", row.names = T)
```

```{r}
# RENAME NA FIELDS | DO NOT USE ####
beers$ABV <- ifelse(is.na(beers$ABV),"Missing_ABV_Data",beers$ABV)
beers$IBU <- ifelse(is.na(beers$IBU),"Missing_IBU_Data",beers$IBU)


str(which(is.na(beers$IBU) & is.na(beers$ABV), arr.ind = TRUE))

view(beers)
```

Merge Datasets together for Question #2
```{r}
# MERGE SAFE_BEERS AND ALL BEER DATA ####
# Rename Column Names for Consistency and Merge Process
colnames(beers)[5] <- c("Brew_ID")
colnames(beers)[1] <- c("Beer_Name")
colnames(breweries)[2] <- c("Brewery")

colnames(safe_beers)[5] <- c("Brew_ID")
colnames(safe_beers)[1] <- c("Beer_Name")


# Merge Data
#beer_ds <- merge(beers,breweries, by = "Brew_ID")

## CREATE ALL_BEER_DS ####
all_beer_ds <- merge(safe_beers,breweries, by = "Brew_ID")

# Check Data
#str(beer_ds)
str(all_beer_ds)
```


Handle Missing Values for Question #3
```{r}
## Drop Missing Values - Use Until Loop is Fixed ####
# all_beer_ds = drop_na(all_beer_ds)
# DROP ------------------------------------
```

Replace ABV and IBU missing values with Styled median values. This way when we go to grab the median or results wont be so skewed. Especially since we have close to half of the data set missing values.
```{r}
# HANDLING MISSING VALUES WITH CUMPUTED VALUES ####

all_beer_ds$Style = as.factor(all_beer_ds$Style)

## FInd Median based on Styel ####
style_ABV_cnt <- aggregate(ABV ~ Style, all_beer_ds, median)
style_IBU_cnt <- aggregate(IBU ~ Style, all_beer_ds, median)

## Find the Median IBU for all beers ####
no_style_IBU_cnt <- median(style_IBU_cnt$IBU)

# Grab the index of each NA row by ABV and IBU ####
index_safe_beers_ABV = which(is.na(all_beer_ds$ABV))
index_safe_beers_IBU = which(is.na(all_beer_ds$IBU))

## ABV LOOP MEDIAN ####
for (i in 1:length(index_safe_beers_ABV)) {
  all_beer_ds[index_safe_beers_ABV[i], "ABV"] = style_ABV_cnt[style_ABV_cnt$Style == all_beer_ds[index_safe_beers_ABV[i], "Style"], "ABV"]
}



## IBU LOOP MEDIAN ####
for (j in 1:1005) {
  all_beer_ds[index_safe_beers_IBU[j], "IBU"] <-  style_IBU_cnt[style_IBU_cnt$Style == all_beer_ds[index_safe_beers_IBU[j], "Style"], "IBU"] 
}
```

```{r}
### FIX ####
for (j in 1:length(index_safe_beers_IBU)) {
  
  if (style_IBU_cnt$Style == all_beer_ds[index_safe_beers_IBU[j], "Style"] ) {
  
  all_beer_ds[index_safe_beers_IBU[j], "IBU"] = style_IBU_cnt[style_IBU_cnt$Style == all_beer_ds[index_safe_beers_IBU[j], "Style"], "IBU" ]
  }
  
   all_beer_ds[index_safe_beers_IBU[j], "IBU"] = no_style_IBU_cnt
}

#all_beer_ds[75, ] # ABV
#all_beer_ds[17, ] # IBU


```


```{r}
# REMOVE STRING VALUES FROM NUMERIC COLUMN SO MATHMATICAL FORUMALS WILL WORK ####

## Beers_ds CHECKPOINT ####
beers_ds <- all_beer_ds

beers_ds$State = as.factor(beers_ds$State)
beers_ds$IBU = as.numeric(beers_ds$IBU)
beers_ds$ABV = as.numeric(beers_ds$ABV)

#beers_ds <- beers_ds %>%
  #filter(!is.character(IBU))

#beers_ds <- beers_ds %>%
  #filter(!is.character(ABV))

#beers_ds = drop_na(beers_ds)

str(beers_ds)
```



Compute the median alcohol content and international bitterness unit for each state. Question #4
```{r}
# DATAFRAME FOR MEDIAN AND MEAN VALUES ####
# WILL BE USED FOR PLOTTING
plot_ds <- as.data.frame(matrix(nrow = 50, ncol = 0))

plot_ds
```

```{r}
# Compute the median alcohol content and international bitterness unit for each state. ####
## IBU Median by State ####
plot_ds <- beers_ds %>% group_by(State) %>%
  summarise(median = median(IBU))

plot_ds <- arrange(plot_ds, desc(median))

colnames(plot_ds)[2] <- c("IBU_Median")

plot_ds
```

```{r}
## ABV median by State ####
ABV_Median <- beers_ds %>% group_by(State) %>%
  summarise(median = median(ABV))

ABV_Median <- arrange(ABV_Median, desc(median))

ABV_Median

# Merge data with Plot data
plot_ds <- merge(plot_ds, ABV_Median, by = "State")

colnames(plot_ds)[3] <- c("ABV_Median")

plot_ds
```

```{r}
## IBU Mean by State ####
IBU_Mean <- beers_ds %>% group_by(State) %>%
  summarise(mean = mean(IBU))

IBU_Mean <- arrange(IBU_Mean, desc(mean))

IBU_Mean

# Merge data with Plot data
plot_ds <- merge(plot_ds, IBU_Mean, by = "State")

colnames(plot_ds)[4] <- c("IBU_Mean")

plot_ds
```

```{r}
## ABV Mean by State ####
ABV_Mean <- beers_ds %>% group_by(State) %>%
  summarise(mean = mean(ABV))

ABV_Mean <- arrange(ABV_Mean, desc(mean))

ABV_Mean

# Merge data with Plot data
plot_ds <- merge(plot_ds, ABV_Mean, by = "State")

colnames(plot_ds)[5] <- c("ABV_Mean")

plot_ds
```

```{r}
# MERGE MEDIAN DATASET WITH STATE ABBREVIATIONS ####
plt_ds = plot_ds

# Change from factor to character
plt_ds$State <- as.character(plt_ds$State)

# Remove spaces in state field
plt_ds$State <- gsub("\\s", "", plt_ds$State)

# MERGE median values
#all_beer_ds <- merge(all_beer_ds, plt_ds, by = "State")

# Left Merge the data
plt_ds <- merge(plt_ds, state_abb_list, by = "State", all.x = T )

str(plt_ds)

```


```{r}
# MERGE AND CREATE FULL DATASET FOR CHARTS ####
## ALL BEERS DS BACKUP CHECK POINT ####
backup_ds = all_beer_ds

# RECOVER DATA
#all_beer_ds = backup_ds 

# Remove spaces in state field
#all_beer_ds$State <- gsub("\\s", "", all_beer_ds$State)

#all_beer_ds <- merge(all_beer_ds, state_abb_list, by = "State", all.x = T )

str(beer_ds)
str(all_beer_ds)
str(backup_ds)
```

```{r}
# MERGE STATE LAT AND LONG | FIX THIS IS DOUBLING ####

# Has Lat and long cordinates
US_Map <- map_data("world") %>% filter(region=="USA")

# rename column for merge
colnames(US_Map)[6] <- c("Full_State")


#str(US_Map)
#str(plt_ds)

#view(US_Map)


# Left Merge 
plt_ds = merge(plt_ds, US_Map, by = "Full_State", all.x = T)


str(plt_ds)

```

Compute the Number of Breweries by State Question #1
```{r}
# How many breweries are present in each state? | State_cnt ####
state_cnt <- all_beer_ds %>% count(State, sort = T)

colnames(state_cnt)[2] <- "Number_of_States"

state_cnt <- arrange(state_cnt, desc(Number_of_States))

# Remove spaces in state field
state_cnt$State <- gsub("\\s", "", state_cnt$State)

# Left Merge 
state_cnt = merge(state_cnt, state_abb_list, by = "State", all.y = T)


str(state_cnt)
```


```{r}
# PLOT1 Facet Wrap| How many breweries are present in each state? ####
state_cnt %>% arrange(state_cnt, desc(Number_of_States)) %>%
  ggplot(aes(x = Number_of_States, fill = Full_State)) +
  geom_histogram() +
  xlab("Number of Breweries by States") +
  ylab("") +
  facet_wrap(Number_of_States ~ Full_State) +
  scale_y_discrete() +
  theme(legend.position = "none")
  
```

```{r}
# PLOT2 Bar Chart| How many breweries are present in each state? ####
## FIX NOT GRABBING ACTUAL TOP TEN ####
Top_Ten <- state_cnt[order(-state_cnt$Number_of_States), ]
  
head(Top_Ten, 10) %>% 
  ggplot(aes(reorder(Number_of_States, x = Full_State), x = Number_of_States, fill = Full_State)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Number_of_States), size = 4, hjust = 1) + 
  xlab("Number of Breweries") +
  ylab("State") +
  theme(legend.position = "none")

# ?color
```

Question #4 Charts
```{r}
# MAP PLOT IBU MEDIAN AND MEAN | WORK IN####
# US MAP 
plot_usmap(regions = "states") + 
  geom_point(x = 88.07113, y = 30.25234, color = "blue", size = 3) +
  geom_point(x = 31.9686, y = 99.9018, color = "Pink")
  labs(title = "U.S. States",
       subtitle = "This is a blank map of the United States.") + 
  theme(panel.background=element_blank())

## MAINE MAP PLOT ####
plot_usmap(include = c("ME")) +
  labs(title = "MAINE") +
  theme(panel.background = element_rect(color = "blue"))

## COLORADO MAP PLOT ####
plot_usmap(include = c("CO")) +
  labs(title = "COLORADO") +
  theme(panel.background = element_rect(color = "blue"))

## NEW ENGLAND PLOT ####
plot_usmap(include = c("CT", "ME", "MA", "NH", "VT")) +
  labs(title = "New England Region") +
  theme(panel.background = element_rect(color = "blue"))

# MAP PLOT NEEDS LAT AND LONG FOR STATE ABBREVIATION TO WORK
#Heat MAP Video ####

plt_ds %>% ggplot() +
  geom_polygon(aes(x = long, y = lat)) +
  geom_point(aes(x = IBU_Mean, y = IBU_Median, fill = State))
  

```

Which state has the most bitter (IBU) beer? Question #5
```{r}
# PLOT IBU Median by States ####
plot_ds %>% arrange(IBU_Median, desc(State)) %>%
  ggplot(aes(x = IBU_Median, fill = State)) +
  geom_histogram() +
  xlab("IBU Median by States") +
  ylab("") +
  facet_wrap(IBU_Median ~ State) +
  scale_y_discrete() +
  theme(legend.position = "none")

```
MEAN PLOT
```{r}
# FIX ROUNDING ####
plot_ds$IBU_Mean <- round(plot_ds$IBU_Mean, digits = 3)

# PLOT IBU Mean by States ####
plot_ds %>% arrange(IBU_Mean, desc(State)) %>%
  ggplot(aes(x = IBU_Mean, fill = State)) +
  geom_histogram() +
  xlab("IBU Mean by States") +
  ylab("") +
  facet_wrap(IBU_Mean ~ State) +
  scale_y_discrete() +
  theme(legend.position = "none")

```



Which state has the maximum alcoholic (ABV) beer? Question #5 & 6
```{r}
# FIX ROUNDING ####
plot_ds$ABV_Median <- round(plot_ds$ABV_Median, digits = 3)

# PLOT ABV Median by States ####
plot_ds %>% arrange(ABV_Median, desc(State)) %>%
  ggplot(aes(x = ABV_Median, fill = State)) +
  geom_histogram() +
  xlab("ABV Median by States") +
  ylab("") +
  facet_wrap(ABV_Median ~ State) +
  scale_y_discrete() +
  theme(legend.position = "none")

```
MEAN PLOT
```{r}
# FIX ROUNDING ####
plot_ds$ABV_Mean <- round(plot_ds$ABV_Mean, digits = 3)

# PLOT ABV Mean by States ####
plot_ds %>% arrange(ABV_Mean, desc(State)) %>%
  ggplot(aes(x = ABV_Mean, fill = State)) +
  geom_histogram() +
  xlab("ABV Mean by States") +
  ylab("") +
  facet_wrap(ABV_Mean ~ State) +
  scale_y_discrete() +
  theme(legend.position = "none")

```

Draw a scatter plot.  7. Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Question #7
```{r}
# MEDIAN PLOT | relationship between IBU and ABV ####
plot_ds %>% ggplot() +
  geom_point(aes(x = ABV_Median , y = IBU_Median)) +
  geom_smooth(aes(x = ABV_Median , y = IBU_Median))
  
```

```{r}
# All Data PLOT | relationship between IBU and ABV ####
all_beer_ds %>% ggplot() +
  geom_point(aes(x = ABV, y = IBU, color = IBU), position = "jitter") +
  geom_smooth(aes(x = ABV, y = IBU, color = IBU)) +
  scale_color_gradient2(low = "grey", high = "red")
  
```

What is the probability of picking a beer like Budweiser lager in this list of craft beers.
```{r}
# KNN Classification | FOR PRESENTATION ####
train = drop_na(all_beer_ds)## Do not want to have to drop na values ####

test = data.frame(ABV = .05, IBU = .12) 

#all_beer_ds[, 5:6]
class <- knn(train[, 4:5], test, train$Style, k = 5, prob = T)

class

#confusionMatrix(class, test)
```


Question #8 - difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA). 
```{r}
# Create KNN Train and Test Datasets ####
train2 = train[grepl("Ale", train$Style), ] # Everything Ale and IPA

train3 = train2[!grepl("IPA", train2$Style), ] # ONLY ALE and NO IPA Training set

test2 = train[grepl("IPA", train$Style), ] # ONLY IPA
```

DO NOT USE THIS ONE
```{r}
## What is the probability of finding a beer similar to an IPA in a list of ALE and IPA Only beers by ABV and IBU. WILL ####
class2 <- knn(train2[, 4:5], test2[, 4:5], train2$Style, k = 5, prob = T)

class2

table(test2$Style, class2)

confusionMatrix(table(test2$Style, class2))
```

What is the probability that we will find similar style beers within the entire dataset based off the ABV and IBU
```{r}
class4 <- knn.cv(train2[, c(4:5)], train2$Style, k = 5, prob = T)

table(class5, train2$Style)

confusionMatrix(table(class5, train2$Style))
```

What is the probability of finding a beer similar to an IPA from a list of all ALE based off ABV or IBU. What would the style and probability be?
```{r}
class3 <- knn(train3[, 4:5], test2[, 4:5], train3$Style, k = 5, prob = T)

table(test2$Style, class3)

confusionMatrix(table(test2$Style, class3))
```

```{r}
# Grab a list of the ALE beers that had a match to an IPA
Style_List <- unique(class3)

Style_List = as.data.frame(Style_List)
```


```{r}
# Bar chart of the most likely beers
Style_List %>% ggplot() +
  geom_histogram(aes(y = Style_List, x = length(Style_List)), stat = "identity")
```


